# Runbook: Fix Vulnerabilità

## Procedura

### 1. Analisi

- Identifica il file e la riga esatta del problema
- Determina la severità (critica/alta/media/bassa)
- Identifica se ci sono route simili con lo stesso problema

### 2. Fix Auth Inline → requireAuth()

Se una route usa auth inline invece di `requireAuth()`:

```typescript
// PRIMA (auth inline — da evitare)
const { data: { user } } = await supabase.auth.getUser();
if (!user) return NextResponse.json({ error: "..." }, { status: 401 });

// DOPO (requireAuth — corretto)
import { requireAuth, isAuthError } from "@/lib/middleware/auth";
const authResult = await requireAuth(req);
if (isAuthError(authResult)) return authResult as NextResponse;
const { user, supabase } = authResult as AuthResult;
```

### 3. Fix Security Headers

In `next.config.ts`, sezione `headers()`:

```typescript
{
  key: "Content-Security-Policy",
  value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' fonts.googleapis.com; font-src 'self' fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self' *.supabase.co *.anthropic.com *.googleapis.com;"
},
{
  key: "Strict-Transport-Security",
  value: "max-age=31536000; includeSubDomains"
}
```

### 4. Fix CSRF

Aggiungi token CSRF per form mutations (Stripe checkout, etc).
Pattern da seguire: verifica `Origin` header contro `NEXT_PUBLIC_APP_URL`.

```typescript
// In route POST/PUT/DELETE sensibili
const origin = req.headers.get("origin");
const allowedOrigin = process.env.NEXT_PUBLIC_APP_URL;
if (origin && origin !== allowedOrigin) {
  return NextResponse.json({ error: "CSRF check failed" }, { status: 403 });
}
```

### 5. Validazione

- Testa manualmente la route dopo il fix
- Verifica che utenti non autenticati ricevano 401
- Verifica che utenti autenticati funzionino normalmente

### 6. Aggiornamento documentazione

Aggiorna `docs/ARCHITECTURE.md` sezione 2.3 marcando la vulnerabilità come ✅ RISOLTO.
